"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("inferno"),t=require("stream"),r="a runtime error occured! Use Inferno in development environment to find the error.",n=Array.isArray;function o(e){var t=typeof e;return"string"===t||"number"===t}function i(e){return void 0===e||null===e}function u(e){return null===e||!1===e||!0===e||void 0===e}function s(e){return"function"===typeof e}function a(e){return"string"===typeof e}function c(e){return"number"===typeof e}function l(e){return null===e}function d(e){return void 0===e}function h(e){throw e||(e=r),new Error("Inferno Error: "+e)}function f(e,t){var r={};if(e)for(var n in e)r[n]=e[n];if(t)for(var o in t)r[o]=t[o];return r}function p(e){if(a(e))return e;var t="";for(var r in e){var n=e[r];o(n)&&(t+=r+":"+n+";")}return t}var v=new RegExp(/["'&<>]/);function m(e){if(!v.test(e))return e;var t,r="",n="",o=0;for(t=0;t<e.length;++t){switch(e.charCodeAt(t)){case 34:n="&quot;";break;case 39:n="&#039;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}t>o&&(r+=e.slice(o,t)),r+=n,o=t+1}return r+e.slice(o,t)}var g=":A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",y=g+"\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040",x=new RegExp("^["+g+"]["+y+"]*$"),T={},Q={};function k(e){if(void 0!==Q[e])return!0;if(void 0!==T[e])return!1;if(x.test(e))return Q[e]=!0,!0;return T[e]=!0,!1}var F=new Set(["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"]);function b(e,t,r){if(e.constructor.getDerivedStateFromProps)return f(r,e.constructor.getDerivedStateFromProps(t,r));return r}function S(t,r){var n=t.props||e.EMPTY_OBJ;return 32768&t.flags?t.type.render(n,t.ref,r):t.type(n,r)}function P(t,r,o){var d=t.flags,v=t.type,g=t.props||e.EMPTY_OBJ,y=t.children;if(0!==(14&d)){if(4&d){var x,T=new v(g,o),Q=Boolean(v.getDerivedStateFromProps);if(T.$BS=!1,T.$SSR=!0,s(T.getChildContext)&&(x=T.getChildContext()),x=i(x)?o:f(o,x),T.props===e.EMPTY_OBJ&&(T.props=g),T.context=o,!Q&&s(T.componentWillMount)){T.$BR=!0,T.componentWillMount(),T.$BR=!1;var C=T.$PS;if(C){var _=T.state;if(null===_)T.state=C;else for(var N in C)_[N]=C[N];T.$PSS=!1,T.$PS=null}}Q&&(T.state=b(T,g,T.state));var w=T.render(g,T.state,T.context);if(u(w))return"\x3c!--!--\x3e";if(a(w))return m(w);if(c(w))return w+"";return P(w,t,x)}var M=S(t,o);if(u(M))return"\x3c!--!--\x3e";if(a(M))return m(M);if(c(M))return M+"";return P(M,t,o)}if(0!==(481&d)){var B,$="<"+v,R=F.has(v),D=t.className;if(a(D)?$+=' class="'+m(D)+'"':c(D)&&($+=' class="'+D+'"'),!l(g)){for(var E in g){var V=g[E];switch(E){case"dangerouslySetInnerHTML":B=V.__html;break;case"style":i(g.style)||($+=' style="'+p(g.style)+'"');break;case"children":case"className":break;case"defaultValue":g.value||($+=' value="'+(a(V)?m(V):V)+'"');break;case"defaultChecked":g.checked||($+=' checked="'+V+'"');break;default:k(E)&&(a(V)?$+=" "+E+'="'+m(V)+'"':c(V)?$+=" "+E+'="'+V+'"':!0===V&&($+=" "+E))}}"option"===v&&"undefined"!==typeof g.value&&g.value===r.props.value&&($+=" selected")}if(R)$+=">";else{$+=">";var A=t.childFlags;if(2===A)$+=P(y,t,o);else if(12&A)for(var O=0,I=y.length;O<I;++O)$+=P(y[O],t,o);else 16===A?$+=""===y?" ":m(y):B&&($+=B);R||($+="</"+v+">")}if(String(v).match(/[\s\n\/='"\0<>]/))throw $;return $}if(0!==(16&d))return""===y?" ":m(y);if(n(t)||0!==(8192&d)){var W=t.childFlags;if(2===W||n(t)&&0===t.length)return"\x3c!--!--\x3e";if(12&W||n(t)){for(var j=n(t)?t:y,J="",Y=0,q=j.length;Y<q;++Y)J+=P(j[Y],t,o);return J}}else h();return""}function C(e){return P(e,{},{})}function _(e){var t=e.$PS;if(t){var r=e.state;if(null===r)e.state=t;else for(var n in t)r[n]=t[n];e.$PS=null}e.$BR=!1}var N=function(t){function r(e){t.call(this),this.collector=[1/0],this.promises=[],this.pushQueue=this.pushQueue.bind(this),e&&this.renderVNodeToQueue(e,null,null)}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r.prototype._read=function(){setTimeout(this.pushQueue,0)},r.prototype.addToQueue=function(e,t){if(i(t))"string"===typeof e&&this.collector.length-1===0?this.push(e):"string"===typeof e&&"string"===typeof this.collector[this.collector.length-2]?this.collector[this.collector.length-2]+=e:this.collector.splice(-1,0,e);else{var r=this.promises[t].length-1;"string"===typeof this.promises[t][r]&&"string"===typeof e?this.promises[t][r]+=e:this.promises[t].push(e)}},r.prototype.pushQueue=function(){var e=this.collector[0];if("string"===typeof e)this.push(e),this.collector.shift();else if(e&&("object"===typeof e||s(e))&&s(e.then)){var t=this;e.then((function(e){var r;(r=t.collector).splice.apply(r,[0,1].concat(t.promises[e])),t.promises[e]=null,setTimeout(t.pushQueue,0)})),this.collector[0]=null}else e===1/0&&this.emit("end")},r.prototype.renderVNodeToQueue=function(t,r,o){var v=this,g=t.flags,y=t.type,x=t.props||e.EMPTY_OBJ,T=t.children;if((14&g)>0)if(4&g){var Q,P=new y(x,r),C=Boolean(y.getDerivedStateFromProps);if(P.$BS=!1,P.$SSR=!0,d(P.getChildContext)||(Q=P.getChildContext()),i(Q)||(r=f(r,Q)),P.props===e.EMPTY_OBJ&&(P.props=x),P.context=r,!C&&s(P.componentWillMount)&&(P.$BR=!0,P.componentWillMount(),_(P)),s(P.getInitialProps)){var N=P.getInitialProps(P.props,P.context);if(N){if(Promise.resolve(N)===N){var w=this.promises.push([])-1;return void this.addToQueue(N.then((function(e){"object"===typeof e&&(P.props=f(P.props,e));var t=P.render(P.props,P.state,P.context);return u(t)?v.addToQueue("\x3c!--!--\x3e",w):a(t)?v.addToQueue(m(t),w):c(t)?v.addToQueue(t+"",w):v.renderVNodeToQueue(t,P.context,w),setTimeout(v.pushQueue,0),w})),o)}P.props=f(P.props,N)}}C&&(P.state=b(P,x,P.state));var M=P.render(P.props,P.state,P.context);u(M)?this.addToQueue("\x3c!--!--\x3e",o):a(M)?this.addToQueue(m(M),o):c(M)?this.addToQueue(M+"",o):this.renderVNodeToQueue(M,r,o)}else{var B=S(t,r);u(B)?this.addToQueue("\x3c!--!--\x3e",o):a(B)?this.addToQueue(m(B),o):c(B)?this.addToQueue(B+"",o):this.renderVNodeToQueue(B,r,o)}else if((481&g)>0){var $,R="<"+y,D=F.has(y),E=t.className;if(a(E)?R+=' class="'+m(E)+'"':c(E)&&(R+=' class="'+E+'"'),!l(x))for(var V in x){var A=x[V];switch(V){case"dangerouslySetInnerHTML":$=A.__html;break;case"style":i(x.style)||(R+=' style="'+p(x.style)+'"');break;case"children":case"className":break;case"defaultValue":x.value||(R+=' value="'+(a(A)?m(A):A)+'"');break;case"defaultChecked":x.checked||(R+=' checked="'+A+'"');break;default:k(V)&&(a(A)?R+=" "+V+'="'+m(A)+'"':c(A)?R+=" "+V+'="'+A+'"':!0===A&&(R+=" "+V))}}if(R+=">",String(y).match(/[\s\n\/='"\0<>]/))throw R;if(D)this.addToQueue(R,o);else{var O=t.childFlags;if(2===O)return this.addToQueue(R,o),this.renderVNodeToQueue(T,r,o),void this.addToQueue("</"+y+">",o);if(16===O)return this.addToQueue(R,o),this.addToQueue(""===T?" ":m(T+""),o),void this.addToQueue("</"+y+">",o);if(12&O){this.addToQueue(R,o);for(var I=0,W=T.length;I<W;++I)this.renderVNodeToQueue(T[I],r,o);return void this.addToQueue("</"+y+">",o)}if($)return void this.addToQueue(R+$+"</"+y+">",o);D||this.addToQueue(R+"</"+y+">",o)}}else if((16&g)>0)this.addToQueue(""===T?" ":m(T),o);else if(n(t)||0!==(8192&g)){var j=t.childFlags;if(2===j||n(t)&&0===t.length)this.addToQueue("\x3c!--!--\x3e",o);else if(12&j||n(t)){for(var J=n(t)?t:t.children,Y=0,q=J.length;Y<q;++Y)this.renderVNodeToQueue(J[Y],r,o);return}}else h()},r}(t.Readable);function w(e){return new N(e)}var M=Promise.resolve(),B=function(e){function t(t){e.call(this),this.started=!1,this.initNode=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._read=function(){var e=this;if(this.started)return;this.started=!0,M.then((function(){return e.renderNode(e.initNode,null)})).then((function(){e.push(null)})).catch((function(t){e.emit("error",t)}))},t.prototype.renderNode=function(e,t){var r=e.flags;if((14&r)>0)return this.renderComponent(e,t,4&r);if((481&r)>0)return this.renderElement(e,t);if(n(e)||0!==(8192&r))return this.renderArrayOrFragment(e,t);return this.renderText(e)},t.prototype.renderArrayOrFragment=function(e,t){var r=this,o=e.childFlags;if(2===o||n(e)&&0===e.length)return this.push("\x3c!--!--\x3e");if(12&o||n(e))return(n(e)?e:e.children).reduce((function(e,n){return e.then((function(){return Promise.resolve(r.renderNode(n,t)).then((function(){return!!(16&n.flags)}))}))}),Promise.resolve(!1))},t.prototype.renderComponent=function(e,t,r){var n=this,o=e.type,l=e.props;if(!r){var d=S(e,t);if(u(d))return this.push("\x3c!--!--\x3e");if(a(d))return this.push(m(d));if(c(d))return this.push(d+"");return this.renderNode(d,t)}var h,p=new o(l,t),v=Boolean(o.getDerivedStateFromProps);return p.$BS=!1,p.$SSR=!0,s(p.getChildContext)&&(h=p.getChildContext()),i(h)||(t=f(t,h)),p.context=t,p.$BR=!0,Promise.resolve(!v&&p.componentWillMount&&p.componentWillMount()).then((function(){_(p),v&&(p.state=b(p,l,p.state));var e=p.render(p.props,p.state,p.context);if(u(e))return n.push("\x3c!--!--\x3e");if(a(e))return n.push(m(e));if(c(e))return n.push(e+"");return n.renderNode(e,t)}))},t.prototype.renderChildren=function(e,t,r){var n=this;if(2===r)return this.renderNode(e,t);if(16===r)return this.push(""===e?" ":m(e+""));if(12&r)return e.reduce((function(e,r){return e.then((function(){return Promise.resolve(n.renderNode(r,t)).then((function(){return!!(16&r.flags)}))}))}),Promise.resolve(!1))},t.prototype.renderText=function(e){this.push(""===e.children?" ":m(e.children))},t.prototype.renderElement=function(e,t){var r,n=this,o=e.type,u=e.props,s="<"+o,d=F.has(o),h=e.className;if(a(h)?s+=' class="'+m(h)+'"':c(h)&&(s+=' class="'+h+'"'),!l(u))for(var f in u){var v=u[f];switch(f){case"dangerouslySetInnerHTML":r=v.__html;break;case"style":i(u.style)||(s+=' style="'+p(u.style)+'"');break;case"children":case"className":break;case"defaultValue":u.value||(s+=' value="'+(a(v)?m(v):v)+'"');break;case"defaultChecked":u.checked||(s+=' checked="'+v+'"');break;default:if(k(f)){a(v)?s+=" "+f+'="'+m(v)+'"':c(v)?s+=" "+f+'="'+v+'"':!0===v&&(s+=" "+f);break}}}if(s+=">",this.push(s),String(o).match(/[\s\n\/='"\0<>]/))throw s;if(d)return;if(r)return this.push(r),void this.push("</"+o+">");var g=e.childFlags;if(1===g)return void this.push("</"+o+">");return Promise.resolve(this.renderChildren(e.children,t,g)).then((function(){n.push("</"+o+">")}))},t}(t.Readable);function $(e){return new B(e)}exports.RenderQueueStream=N,exports.RenderStream=B,exports.renderToStaticMarkup=C,exports.renderToString=C,exports.streamAsStaticMarkup=$,exports.streamAsString=$,exports.streamQueueAsStaticMarkup=w,exports.streamQueueAsString=w;
