# 2000￥ 买培训赠比赛: APIO 2021

$2000￥/5day = 400￥/day$

## Day1: 四边形不等式

这部分内容证明部分是真的催吐, [一维的还好](https://www.luogu.com.cn/blog/Wild-Donkey/si-bian-xing-fou-deng-shi-optimization-of-quadrilateral-inequality), [二维实在是折磨人](https://www.luogu.com.cn/blog/Wild-Donkey/luogu4767-ioi2000-you-ju). 黄神还以为我在用公式画波浪线...

既然四边形不等式的应用就是用暴力打表, 无脑证明, 这一部分已经在前面的学习中掌握了, 接下来就是记录一下在前面的学习中, 我没有研究到的内容.

所以这个老师终于解释了四边形不等式的定义, 原来四边形不等式是原生二维, 是定义在矩阵上的概念. 所以我在[这里](https://www.luogu.com.cn/blog/Wild-Donkey/si-bian-xing-fou-deng-shi-optimization-of-quadrilateral-inequality)提到的 $f_{i, j}$ 指的是矩阵的第 $i$ 行, 第 $j$ 列. 而定义中的四个值便是第 $a$, $b$ 行, 第 $c$, $d$ 列的四个交点元素的关系. 结合二维 DP 的应用和单调矩阵的定义, 这一切顿时变得顺理成章了起来.

### 单调矩阵

一个矩阵的每一行的列数最大的最小值所在的列数都不在上一行之前 (列数单调), 则称这个矩阵是单调矩阵. 如果一个矩阵的每个子矩阵都是单调矩阵, 则说这个矩阵是完全单调矩阵.

对于 $nm$ 的完全单调矩阵 $A$ 和 $1 \leq i < j \leq m$, 有两种性质:

存在整数 $0 \leq p_{i,j} \leq n$ 使得对于任意 $1 \leq k \leq n$, $A_{k, i} < A_{k, j}$ 当且仅当 $k \leq p_{i, j}$

定义某个元素是冗余的当且仅当其不是对应行的最小值所在位置, 若 $A_{k, i} < A_{k, j}$, 则 $A_{1, j}, A_{2, j}, · · · , A_{k, j}$ 都是冗余的, 否则 $A_{k, i}, A_{k+1, i}, · · · , A_{n, i}$ 都是冗余的.

定义某一列是冗余的当且仅当其所有元素都是冗余的.

### 转置矩阵

是将任意矩阵行号列号交换得到的矩阵. 也用矩阵转置来命名矩阵这种运算.

### 蒙日阵

我们把满足四边形不等式的矩阵称为蒙日阵, 即对 $a \leq b$, $c \leq d$:

$$
A_{a, c} + A_{b, d} \leq A_{a, d} + A_{b, c}
$$

判断蒙日阵的充要条件是对于每一个 $a$, $b$, 有

$$
A_{a, b} + A_{a + 1, b + 1} \leq A_{a + 1, b} + A_{a, b + 1}
$$

所有蒙日阵都是完全单调矩阵.

假设 $A$, $B$ 是两个行列数相同的蒙日阵, 则以下矩阵也是蒙日阵:

- $A + B$

- $\lambda A$

- $A^T$

- $A$ 的某一行或某一列加一个常数得到的矩阵

- $A$ 的转置矩阵

### 决策单调性 + 离线 = 分治求最值

求一个单调矩阵的每一行的列数最大的最小值的列数, 一个方法是 $O(n^2)$ 扫一遍这个矩阵, 但是对于一些规模非常大, 矩阵元素需要用的时候计算的情况, $O(n^2)$ 就不好使了.

因为单调矩阵的每一行最小值的位置是单调的, 所以只要知道第 $m$ 行的最小值列数 $K_m$ 则对于 $l \leq m \leq r$, 一定有 $K_l \leq K_m \leq K_r$.

这样就把 $m$ 左边和右边行的最小值的列数的取值变成了原来的一半. 所以左右两个区间的中点的暴力总共需要 $O(n)$ 的复杂度. 每层分治是 $O(n)$, 总共有 $O(logn)$ 层分治, 所以分治算法的总复杂度是 $O(nlogn)$.

### 小 Z 的游览计划

先给出最小生成树的更为广义的定义: 包含给定点集中的点的边权总和最小的连通子图.

最小斯坦纳树和最小生成树类似, 但是在包含给定点集的点的前提下, 也可以包含额外的点, 只要满足联通和边权和最小即可.

给一棵树, 树上的边权都是 $1$. 和树上节点的一个排列, 将排列分为非空的 $k$ 段区间, 求一个划分方式, 使得每段区间的点集的最小斯坦纳树权值总和最大, 输出这个权值总和.

$nk \leq 2 * 10^5$

二维 DP, 设 $w_{i, j}$ 是区间 $[i, j]$ 对应的最小斯坦纳树的权值和, 则 $w_{i, j}$ 打表证明 $w_{i, j}$ 一定满足反向四边形不等式 ($\leq$ 变成 $\geq$). 既然是反向的, 又是求最大值, 那我们把边权取相反数, 再求最小值, 输出绝对值就好了.

用 $n$ 个 `set` 存区间 $[i, j]$ 的点, 维护 $w_{i, j}$, 可 $O(logn)$ 进行增量到相邻的区间 (增量的概念参考[莫队算法](https://www.luogu.com.cn/blog/Wild-Donkey/pian-fen-dai-shi-mu-dui)).

这个老师没有给出如何操作才能增量, 也没有写 DP 方程, 也没有给出 DP 数组的定义, 真是令人头大. 所以姑且定义一个黑箱 `Calc(i, j)`, 并且认为它的复杂度和上一次 `Calc()` 的参数挂钩, 但是是 $O(nlogn)$ 级别的.

$f_{i, j}$ 表示序列的前 $i$ 位, 分成 $j$ 段的最大权值. 写出状态转移方程:

$$
f_{i, j} = max(f_{k, j - 1} + Calc(k + 1, i))
$$

根据四边形不等式, $f_{i, j}$ 满足决策 $k$ 单调. 决策单调就可以用分治, 先求前 $m$ 位的答案, 然后用前面提到的分治法, 将 $Calc()$ 次数优化到 $O(nlogn)$ 次, 每次计算时由于查询权值的区间是相对连续的, 所以 $Calc()$ 均摊 $O(logn)$, 所以一个阶段的复杂度是 $O(nlog^2n)$. 因为答案要从分成一段的时候迭代过来, 所以一共是 $k$ 个阶段, 所以总复杂度 $O(knlog^2n)$.

### 二分栈

在线增量算法, 

### SMAWK Algorithm

所以是在上面的分治之前沿着 $x = y$ 的直线先切一刀, 剪掉 $\frac{(\min(n, m)^2)}{2}$ 的枝?

没有那么简单, 不是沿着 $x = y$, 而是沿着每一行的目标的点 $(j, p_{i, Aj})$ 连成的折线走, 每次干掉左边的斜边不规则的直角三角形?

看起来是一维的四边形不等式DP...

但是这是穿插着跑一半的答案, 然后插空求剩下的一半???

我觉得这个 Markdown 的最多的字符是 '?' ???????????

因为常数大, 所以常被用来卡交互题的询问数! 妙, 但是我还是想打 '?' ????

### 二维的决策单调性

这时候 $p_{i, j, k}$ 表示状态 $(j, k)$ 的第 $i$ 优决策.

### 最短路的单调性

解决的问题: DAG 上经过 $k$ 条边的最短路. 随着 $k$ 的增加单增.

环上邮局, 就是将邮局的题目首尾相接.

### WQS 优化!!!

对于答案下凸的 DP 的优化???

### 次模函数

### 双调回路

## Day2 Open Cup 选讲

### [Cactus Competition](http://codeforces.com/gym/102759/problem/B)

给定一张 $N × M$ 的网格图, $(i, j)$ 的权值为 $A_i + B_j$,其中 $A_i$, $B_j$ 是给定的两数列.

求有多少对 $(S, T) (1 \leq S \leq T \leq N)$ 满足存在一条从 $(S, 1)$ 走到 $(T, M)$ 的路径, 每一步只能往下或往右走一步, 且经过的所有格子的权值非负.

$1 \leq N, M \leq 2 * 10^5, -10^9 ≤ A_i, B_j \leq 10^9$

### Query On A Tree 17

给定一棵 $N$ 个点的有根树, 初始时每个点的点权为 $0$. 接下来会执行 $Q$ 次操作, 每次操作会是以下两种之一:

- 将 $u$ 子树内所有顶点的点权增加 1。

- 将 u 到 v 路径上内所有顶点的点权增加 1。

在每次操作后, 设顶点 $u$ 的点权为 $A_u$, 则输出一个顶点 $v$, 使得 $\sum(1 \leq u \leq N A_u * dis(u, v))$ 最小. 若有多个满足条件的顶点, 输出深度最小的一个.

$2 \leq N \leq 10^5, 1 \leq Q \leq 1^5$

一个点权的修改可以当成在原来的基础上再 DFS 一遍. 用重链剖分后的 DFS 序表示这棵树.

查询就是成求带权重心, 重链剖分 + 线段树维护点权, 在线段树上二分查询子树和是总权值一半的点, 重心是从这个点到根的路径上的某个点.

### Steel Slicing 2

给定一个多边形. 多边形有 $N$ 列, 每列向上的长度为 $h_i$, 向下的长度为 $l_i$. 相当于 $N$ 个有宽度的线段竖着并在一起.

你可以将多边形切若干刀, 每一道只能恰好将一个多边形分成两个, 也就是说每次切的痕迹是一条线段而非直线. 求出需要最少的刀数, 使得剩下的多边形都是矩形.

$1 \leq N \leq 2.5 * 10^5, 1 \leq h_i, l_i \leq 10^6$

考虑凹顶点数, 因为最后的目标情况就是整个图上没有凹顶点, 而一个正常的人每一刀会减少 $1$ 或 $2$ 个凹顶点, 凹顶点总数一定, 所以要优化切的次数, 就是让一刀减少 $2$ 个凹顶点的数量最多.

分别考虑横着切和竖着切.

竖着切减少两个凹顶点的情况是当切线两端的线段上下端点都不同的情况.

横着切减少两个凹顶点的情况是切线两端的线段的对应端点是刀的高度.

这样就能 O(n) 求出所有可行的减少两个凹顶点的刀.

很显然, 每个凹顶点只能被减少一次, 所以以凹顶点为左部, 以刀为右部建二分图, 跑最大独立集, 保证每凹顶点只被去掉一次.

### Interesting Drug

$N$ 件物品排列在数轴上, 第 $i$ 件物品的坐标为 $i$. 一个人从某个点开始, 可以任意左右移动, 当经过一件物品时, 他就会取得这件物品 (不能跳过). 若物品 $i$ 是第 $C_i$ 件取走的, 则会带来 $D_i$ 的收益.

对每个 $1 \leq i \leq N$, 求出初始坐标为 $i$ 时, 取得所有物品的最大收益.

$2 \leq N \leq 3 * 10^5, 1 \leq D_i \leq 10^9$

因为每个时刻, 拿了的物品一定是连续的区间, 所以倒着做, 每次从左端或右端放回一个物品, 计算权值. 

用二位偏序求答案, 虽然我不会.

### Find the LCA

给定数列 $A_1$, $A_2$, . . . , $A_N$。考虑所有 N 个点的有根树, 其中顶点 $i(2 ≤ i ≤ N)$ 的父亲为 $p_i (1 ≤ pi < i)$, 点权为 $Ai$.

定义一棵树的分数为顶点 $lca(N − 1, N)$ 的子树内所有顶点点权的乘积. 求所有 $(N − 1)!$ 种树的分数的和, 对 $998244353$ 取模.

$3 \leq N \leq 2.5 * 10^5, 1 \leq A_i \leq 998244353$

真就 FFT 呗. 当场去势.

### Japanese Knowledge

给定非降正整数序列 $A_1$, $A_2$, . . . , $A_N$. 对每个 $0 \leq k \leq N$，求满足下列条件的非降非负整数序列 $x_1$, $x_2$, . . . , $x_N$ 的数量，对 $998244353$ 取模.

$x_i \leq A_i, 1 \leq i \leq N$

恰好 $k$ 个下标 $i$ 满足 $x_i = A_i$

$1 ≤ N ≤ 2.5 * 10^5, 1 ≤ A_1 ≤ A_2 ≤ · · · ≤ A_N ≤ 2.5 * 10^5$

又是卷积, 再次去势.

### Chess Tournament

在大赛中 $n$ 位选手要两两进行一场比赛. 大赛包含若干轮, 每一轮至多有 $k$ 对选手同时比赛 (因此这至多 $2k$ 位选手必须互不相同). 设计一个比赛方案使得总轮数最少.

$2 \leq n \leq 200, 1 \leq k \leq n/2$

一个人要比 $n - 1$ 场, 所以最优答案是 $max(\frac{n(n - 1)}{2k}, n - 1)$ (大雾

所以每个人比赛.

## Day3 组合计数

### CF1264D2 Beautiful Bracket Sequence

递归定义合法括号序列及其深度：

• 空串是合法括号序列，深度为 0 。

• 如果 s 是合法括号序列，那么 (s) 也是合法括号序列，深度
为 s 的深度加一。

• 如果 s,t 是合法括号序列，那么 st 也是合法括号序列，深度
为 s,t 的深度的较大值。
定义任意一个括号序列的深度为其所有合法括号子序列的深度的
最大值。

给出一个包含 ()? 的字符串，? 可以任意替换为) 或 ( ，求出每
一种替换方案的深度之和。

$n ≤ 10^6$

### LOJ#3211. 「CSP-S 2019」Emiya 家今天的饭

给定一个 $nm$ 的表格, 每个位置写有非负整数 $a_{i, j}$. 你需要在表格中选若干个位置, 满足:

- 至少选取一个位置

- 每行最多选一个位置

- 设总共选了 $c$ 个位置, 那么不存在一列选的个数超过 $\lfloor \frac c2 \rfloor$.
对于一种合法方案,它的权值是所有选的位置的 $a_{i, j}$ 的乘积. 求所有合法方案的权值之和.

$n \leq 100, m \leq 2000$

$O(n^2m)$

### AGC052C Nondivisible Prefix Sums

给定质数 $P$ 和长度 $n$. 对于 $(P − 1)n$ 个值域在 $[1, P − 1]$ 的数列, 称它是好的, 当且仅当存在一种方法把它重排, 使得每个前缀和都不是 $P$ 的倍数.

求好的数列个数.

$1 \leq n \leq 5000, 3 \leq P \leq 10^8$

简单背包...

### AGC012F Prefix Median

给定长度为 $2n − 1$ 的数列 $a$ (可能有相同元素), 可以将它任意打乱顺序, 然后定义 $b_i$ 为前 $2i − 1$ 个数的中位数. 求能生成多少种数列 $b$

$n \leq 50$

任意打乱顺序, 共有 $(2n - 1)!$ 种排列.

### AGC043D Merge Triplets

给定 $n$, 求长度为 $3n$ 的能被以下方法生成的排列个数.

- 生成 $n$ 个长度为 $3$ 的数列, 使得每个 $1$ 到 $3n$ 中的数恰好被用一次.

- 生成一个初始为空的数列 $P$, 重复以下操作 $3n$ 次

  - 在所有非空数列的开头中选取最小的元素 $x$

  - 把 $x$ 加入到 $P$ 的末尾, 并从原数列删去

$n \leq 2000$

一个结论, 如果一个长度为 $3$ 的小数列的某个数被选取了, 那么紧接着被选的是它所在的数列后面比它小的元素.

新数列是一个栈, 数字会以长度为 $\leq 3$ 的若干段堆进去, 每一段就是在长度为 $3$ 的小数列中的连续被选中的数. 这些小段分为 $3$ 类, 长度为 $2$ 的段一定对应着同序列中的剩下的长度为 $1$ 的段.

容易发现, $3n$ 一定是最后一段的段首, 这个可以感性理解. 对最后一段的长度分类讨论, $1$, $2$, 或 $3$.

### LOJ#3463. 「WC2021」表达式求值

定义 $Z$ 上的二元运算符 $<$, $>$, 分别返回两者取 $\min$ 或 $\max$

给出一个只包含 $<$, $>$, $?$, $($, $)$, $0$ 到 $9$ 的表达式 $E$, 其中 $0$ 到 $9$ 的数字 $i$ 表示变量 $x_i$, $?$ 表示暂未确定这个位置填 $<$ 还是 $>$.

有 $n$ 次询问, 每次给出这些变量的值, 求对于所有把 $?$ 替换为 $<$ 或 $>$ 的方案中, 表达式的返回值的和.

$|E|, n \leq 5 * 10^4$

任何表达式的返回值都是 $0~9$ 的整数. 对 $10$ 个数建 0/1 Trie.

### ARC082E ConvexScore

给定平面上 $n$ 个两两不相同的点, 对于一个点集 $S$, 如果它不在一条直线上 (即凸包存在), 那么设它的凸包大小为 $k$, 它的权值就是 $2^{|S|−k}$

求所有凸包存在的点集的权值之和.

$n \leq 200$

凸包大小定义为构成凸包的点数, 也就是说一个点集的权值是 $2$ 的它的凸包内部的点数次方.

当然我不会求凸包, 所以还是封装成黑箱, 只考虑复杂度的影响.

求整个图的凸包, 求得整个图凸包内部的点, 这时的

### LOJ#3053. 「十二省联考 2019」希望

给定一棵 $n$ 个点的树, 问有多少个长度为 $k$ 的连通块有序列 ${\{si\}}^{k}_{i = 1}$ (即任意选出 $k$ 个树上连通块), 使得存在一个点 $x$, 使得 $∀y \in s_i$, $dis(x, y) \leq L$, 其中 $L$ 给定. $n \leq 10^6, k \leq 10$

因为进一步的优化与本文内容无关, 所以可以认为数据范围是 $n \leq 3000$

### LOJ#2719. 「NOI2018」冒泡排序（简化）

给定一个长度为 $n$ 的排列 $q$, 定义一个排列是好的, 当且仅当它的最长下降子序列长度不超过 $2$.

求字典序严格大于 $q$ 的好的排列有多少个.

$n \leq 6 * 10^5, \sum n \leq 2 * 10^6$

把数分成三类: 

- 左边有比它大的数, 右边没有比它小的数

- 左边没有比它大的数, 右边有比它小的数

- 左边没有比它大的数, 右边没有比它小的数

### AGC041F Histogram Rooks

给定一个 $n$ 列的棋盘, 第 $i$ 列只有下面 $h_i$ 行的格子有效. 要在上面放棋子 (车), 一个棋子可以覆盖同行同列的所有格子 (但不能穿过无效格子). 问有多少种放棋子的方法使得每个有效格子都被覆盖.

$n \leq 400$

钦定一些格子未被覆盖.

笛卡尔树: 

找出最矮的一列, 得到一个高度为这个列的高度, 长度为 $n$ 的矩形, 还有两个规模更小的子问题.

### AGC021E Ball Eat Chameleons

有 $n$ 只变色龙, 初始颜色全部为蓝色. 给它们按某种顺序喂 $K$ 个球，每个球的颜色都是红色或蓝色, 一个球可以选择喂给任意一只变色龙. 一只变色龙吃掉一个球之后, 如果它吃的红球数不等于蓝球数, 那么它会变成较多的那种颜色, 否则不变色. 问有多少种球的颜色序列, 使得存在一种喂球的方案, 把球全部喂完之后所有变色龙都是红色.

$n, K \leq 5 * 10^5$

所以最后, 所有红色变色龙吃的红球数一定大于等于蓝球. 也就是说, 球的序列中, 红球数量不能少于蓝球, 这是序列第一个要满足的条件.

这样就能把一个球看成一个括号, 红的是上括号, 蓝的是下括号. 我们要做的是匹配这些括号, 将它们分配给 $n$ 个变色龙也就是将括号序列分成 $n$ 个互不相交的子序列.

接下来分析什么子序列是合法的, 对于一个左右括号数量不同的子序列, 自然是左括号要更多. 在括号数量相同的子序列, 右括号必须是最后一个.

只要有蓝球, 就喂给已经变红的, 吃红球比吃蓝球多的变色龙.

## Day4 Blocks

### [APIO2019] 桥梁

给定一个 $n$ 个点 $m$ 条边的无向图, 每条边有边权. 需要支持 $q$ 次
以下操作:

- 修改一条边的边权

- 给定起点 $u$ 和权值 $v$, 询问从点 $u$ 开始走, 只能经过边权 $\geq v$ 的边, 能到达多少个不同的点

$n \leq 5 * 10^4, m, q \leq 10^5$

## Day4 Calculating_Graphics

### 半平面交

给 $n$ 个半平面, 每个半平面用一个不等式来描述, 形如 $a_ix + b_iy \leq c_i$. 求所有半平面的交, 也就是求满足所有 $n$ 个不等式的 $x$, $y$.

### 凸集

一个点集, 满足所有的点的连线都在这个点集中. 这里有一个可能会误解的部分, 这里的点集指的是组成这个图形的点, 不是围成多边形的顶点. 因为如果是顶点, 那两点连线中间是空的, 没有任何点, 自然也违背了凸集的定义. 所以凸集的点是稠密的, 图形是没有凹的.

两个凸集的交还是凸集, 因为如果两点同时在两个凸集内, 它们的连线也应该都属于这两个凸集, 所以两凸集求交得到的点集内任意两点连线也在这个交集内, 所以两凸集的交仍是凸集. 相对的, 两个凸集的并集不是凸集.

### 分治求半平面交

### 凸集求交

### 线段求交

### 凸包

### 三维凸包

### Conflict 图

### 凸包与半平面交

### 高维凸包

## Day5 APIO

### hexagon

### jumps

这个题给了 $n$ 个数. 从一个位置可以到另一个位置可行, 当且仅当目标位置是比当前位置更高的左边第一个位置, 或右边第一个位置.

第一个子任务是 $H_i = i + 1$. 也就是说数列是单调递增的, 所以只能从左往右跳, 并且一次跳一格, 这就可以 $O(1)$ 查询了. 因为区间是起点区间严格在目标区间的左边, 所以一定有解. 而这个解就是从起点区间右端到目标区间左端. 答案是 $C - B$.

如果把一次询问已经跳的步数中, 最左边到达的点作为 $L$, 最右边的是 $R$, 那么下一次的跳跃终点一定在这个区间之外. 所以可以写一个 BFS.

一个点被搜到时入队, 保存这时候的左右端点. 扩展一个点的时候, 从左端点往左走, 从右端点往右走. 搜到区间内的点就返回.

将左边的端点都入队, 深度为 $0$, 然后扩展. $O(n)$ 搜索, 总共 $O(n)$ 一次查询. 总复杂度 $O(qn)$.

这个题是一个 DAG, A = B, C = D 求的是最短路, 所以我之前用BFS求最短路. 为了建图, 我们需要知道两条出边的终点 (左右跳到的目标).

如果找 $i$ 的左终点, 如果 $H_{i - 1} > H_i$, 则直接将 $L_i$ 赋值 $i - 1$, 如果不然, 对 $L_{i - 1}$ 进行相同的操作, 直到找到合法的 $L_i$ 为止.

以上是考场口胡.

这个题有一个很重要的结论, 从一个区间出发, 在能到达的前提下, 从这个区间最高的点出发一定不会使答案更劣, 所以应该以起点区间中小于终点区间的最大值的最高点出发, 到终点中比起点大的最靠左的点结束.

### roads

给一个树, 限制每个点的度数, 删掉每条边有不同的花费, 求每个度数限制下, 最优的删边方法的花费. 

第一个子任务, 菊花图, 直接排序, 每次删最小的.

第二个子任务, 对于链, 除了 $ans_1$ 之外都可以轻松求出. 对于 $ans_1$, 跑一个 DP, 用 $f_{i, 0}$ 表示前 $i$ 个点的度数小于等于 $1$, 第 $i$ 条边删掉的状态的最小花费. 用 $f_{i, 1}$ 表示前 $i$ 个点都合法, 第 $i$ 条边留下的最小花费. 写出状态转移方程:

$$
f_{i, 0} = min(f_{i - 1, 1}, f_{i - 1, 0}) + W_{i}\\
f_{i, 1} = f_{i - 1, 0}
$$

边界条件: $f_{0, 0} = W_0, f_{0, 1} = 0$
